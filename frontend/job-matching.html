<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Job Matching - JobSphere</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="icon" href="images/logo.svg">
    <style>
        .job-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 24px;
            border: 1px solid var(--border-color);
            margin-bottom: 20px;
            transition: all 0.3s;
        }
        .job-card:hover {
            border-color: var(--primary);
            transform: translateY(-4px);
            box-shadow: 0 12px 32px rgba(99, 102, 241, 0.3);
        }
        .job-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }
        .job-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }
        .job-company {
            color: var(--text-secondary);
            font-size: 1rem;
            margin-bottom: 5px;
        }
        .job-location {
            color: var(--text-muted);
            font-size: 0.9rem;
        }
        .match-score {
            background: var(--gradient-primary);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 1.1rem;
        }
        .job-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 15px 0;
        }
        .job-tag {
            background: var(--bg-darker);
            color: var(--text-secondary);
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 0.85rem;
        }
        .job-salary {
            color: var(--success);
            font-weight: 600;
            margin-bottom: 15px;
        }
        .job-description {
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 15px;
        }
        .job-actions {
            display: flex;
            gap: 10px;
        }
        .filter-section {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 24px;
            border: 1px solid var(--border-color);
            margin-bottom: 30px;
        }
        .filter-group {
            margin-bottom: 20px;
        }
        .filter-group:last-child {
            margin-bottom: 0;
        }
        .hero-banner {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1));
            border-radius: 16px;
            padding: 40px;
            margin-bottom: 30px;
            text-align: center;
            border: 1px solid var(--border-color);
        }
        .hero-banner img {
            width: 100%;
            max-width: 400px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="navbar-container">
            <a class="navbar-brand" href="index.html"><img src="images/logo.svg" alt="" width="28" height="28"> JobSphere</a>
            
            <div class="navbar-end">
                <a href="dashboard.html" class="btn btn-secondary btn-sm">Dashboard</a>
                <button class="btn btn-primary btn-sm" onclick="Auth.logout()">Logout</button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container" style="margin-top: 80px; padding-bottom: 60px;">
        <!-- Hero Banner -->
        <div class="hero-banner">
            <img src="https://images.unsplash.com/photo-1521791136064-7986c2920216?w=800&auto=format&fit=crop" alt="AI Job Matching">
            <h1>AI-Powered Job Matching</h1>
            <p class="text-secondary" style="max-width: 600px; margin: 0 auto;">
                Our intelligent algorithm analyzes your profile, skills, and preferences to find the perfect job matches for you
            </p>
        </div>

        <!-- Filters -->
        <div class="filter-section">
            <h3 style="margin-bottom: 20px;">Filter Jobs</h3>
            
            <!-- Row 1: Basic Search -->
            <div class="grid grid-3" style="gap: 20px;">
                <div class="filter-group">
                    <label class="form-label">Job Title / Keywords</label>
                    <input type="text" class="form-control" id="jobTitle" placeholder="e.g., Software Engineer">
                </div>
                <div class="filter-group">
                    <label class="form-label">Location</label>
                    <input type="text" class="form-control" id="location" placeholder="e.g., New York, Remote">
                </div>
                <div class="filter-group">
                    <label class="form-label">Country</label>
                    <select class="form-control" id="country">
                        <option value="">All Countries</option>
                        <option value="us">United States</option>
                        <option value="uk">United Kingdom</option>
                        <option value="ca">Canada</option>
                        <option value="in">India</option>
                        <option value="au">Australia</option>
                        <option value="de">Germany</option>
                    </select>
                </div>
            </div>

            <!-- Row 2: Job Type & Filters -->
            <div class="grid grid-4" style="gap: 20px; margin-top: 15px;">
                <div class="filter-group">
                    <label class="form-label">Job Type</label>
                    <select class="form-control" id="jobType">
                        <option value="">All Types</option>
                        <option value="FULLTIME">Full-time</option>
                        <option value="PARTTIME">Part-time</option>
                        <option value="CONTRACT">Contract</option>
                        <option value="INTERN">Internship</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="form-label">Date Posted</label>
                    <select class="form-control" id="datePosted">
                        <option value="">Any time</option>
                        <option value="today">Today</option>
                        <option value="3days">Last 3 days</option>
                        <option value="week">Last week</option>
                        <option value="month">Last month</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="form-label">Sort By</label>
                    <select class="form-control" id="sortByFilter">
                        <option value="relevance">Relevance</option>
                        <option value="date">Most Recent</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="form-label">Results Limit</label>
                    <select class="form-control" id="resultsLimit">
                        <option value="10">10 jobs</option>
                        <option value="20" selected>20 jobs</option>
                        <option value="30">30 jobs</option>
                        <option value="50">50 jobs</option>
                    </select>
                </div>
            </div>

            <!-- Row 3: Salary & Advanced Options -->
            <div class="grid grid-3" style="gap: 20px; margin-top: 15px;">
                <div class="filter-group">
                    <label class="form-label">Min Salary ($)</label>
                    <input type="number" class="form-control" id="minSalary" placeholder="e.g., 50000" min="0" step="1000">
                </div>
                <div class="filter-group">
                    <label class="form-label">Max Salary ($)</label>
                    <input type="number" class="form-control" id="maxSalary" placeholder="e.g., 150000" min="0" step="1000">
                </div>
                <div class="filter-group" style="display: flex; flex-direction: column; justify-content: center;">
                    <label class="form-label" style="display: flex; align-items: center; cursor: pointer; margin-bottom: 10px;">
                        <input type="checkbox" id="remoteOnly" style="margin-right: 8px; cursor: pointer;">
                        Remote Only
                    </label>
                    <label class="form-label" style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" id="useResume" style="margin-right: 8px; cursor: pointer;">
                        Use My Resume
                    </label>
                </div>
            </div>

            <!-- Advanced AI Options -->
            <div style="margin-top: 15px; padding: 15px; background: var(--bg-darker); border-radius: 8px; border: 1px dashed var(--border-color);">
                <label class="form-label" style="display: flex; align-items: center; cursor: pointer; margin: 0;">
                    <input type="checkbox" id="aiBestMatch" style="margin-right: 8px; cursor: pointer;">
                    AI Best Match - Show jobs ranked by skill overlap with your resume
                </label>
            </div>

            <div class="flex-center" style="margin-top: 20px; gap: 10px;">
                <button class="btn btn-secondary" onclick="clearFilters()" type="button">
                    Clear Filters
                </button>
                <button class="btn btn-primary" id="searchButton" type="button" style="cursor: pointer; position: relative; z-index: 10;">
                    Search Matching Jobs
                </button>
            </div>
        </div>

        <!-- Results Header -->
        <div class="flex-between mb-lg" id="resultsHeader" style="display: none;">
            <h2>
                <span id="resultsCount">0</span> Matching Jobs Found
                <span id="apiSourcesInfo" style="font-size: 0.9rem; color: var(--text-muted); margin-left: 10px;"></span>
            </h2>
            <div class="flex gap-sm">
                <select class="form-control" style="width: auto;" id="sortBy" onchange="sortJobs()">
                    <option value="match">Best Match</option>
                    <option value="recent">Most Recent</option>
                    <option value="salary">Highest Salary</option>
                </select>
            </div>
        </div>

        <!-- AI Best Matches Section -->
        <div id="aiBestMatchesSection" style="display: none; margin-bottom: 30px;">
            <div style="background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1)); border-radius: 12px; padding: 20px; border: 1px solid var(--primary);">
                <h3 style="margin-bottom: 15px;">AI-Ranked Best Matches</h3>
                <p style="color: var(--text-secondary); margin-bottom: 20px;">
                    These jobs are specifically ranked based on your skills and experience
                </p>
                <div id="aiBestMatchesContainer"></div>
            </div>
        </div>

        <!-- Job Listings -->
        <div id="jobListings">
            <!-- Jobs will be loaded here -->
        </div>
    </div>

    <script src="js/app.js"></script>
    <script>
        // Wait for DOM to be fully loaded
        window.addEventListener('DOMContentLoaded', function() {
            Auth.requireAuth();
            applyResumeContext();

            // Navbar burger removed - using clean navbar without hamburger menu

            // Add search button click listener
            const searchButton = document.getElementById('searchButton');
            if (searchButton) {
                searchButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('Search button clicked');
                    searchJobs();
                });
            } else {
                console.error('Search button not found!');
            }
        });

        // Note: API_BASE is already defined in js/app.js
        let currentJobs = [];
        let currentResult = null;

        function safeOpenUrl(url) {
            if (url && (url.startsWith('http://') || url.startsWith('https://'))) {
                window.open(url, '_blank', 'noopener,noreferrer');
            } else {
                Toast.show('Invalid or missing URL', 'error');
            }
        }

        function clearFilters() {
            document.getElementById('jobTitle').value = '';
            document.getElementById('location').value = '';
            document.getElementById('country').value = '';
            document.getElementById('jobType').value = '';
            document.getElementById('datePosted').value = '';
            document.getElementById('sortByFilter').value = 'relevance';
            document.getElementById('resultsLimit').value = '20';
            document.getElementById('minSalary').value = '';
            document.getElementById('maxSalary').value = '';
            document.getElementById('remoteOnly').checked = false;
            document.getElementById('useResume').checked = false;
            document.getElementById('aiBestMatch').checked = false;
            
            // Clear results
            displayJobs([]);
            document.getElementById('aiBestMatchesSection').style.display = 'none';
            
            Toast.show('Filters cleared', 'info');
        }

        function getResumeContext() {
            try {
                const raw = sessionStorage.getItem('resumeContext');
                return raw ? JSON.parse(raw) : null;
            } catch (e) {
                return null;
            }
        }

        function applyResumeContext() {
            const resumeContext = getResumeContext();
            if (!resumeContext) return;

            if (resumeContext.job_title) {
                document.getElementById('jobTitle').value = resumeContext.job_title;
            }
            if (resumeContext.location) {
                document.getElementById('location').value = resumeContext.location;
            }
        }

        function displayAIBestMatches(matches) {
            const container = document.getElementById('aiBestMatchesContainer');
            const section = document.getElementById('aiBestMatchesSection');
            
            if (!matches || matches.length === 0) {
                section.style.display = 'none';
                return;
            }
            
            section.style.display = 'block';
            container.innerHTML = matches.slice(0, 5).map((job, index) => {
                const salaryText = job.salary ? `<div class="job-salary">${Toast.escape(job.salary)}</div>` : '';
                const skillsTags = (job.skills || []).slice(0, 5).map(skill => `<span class="job-tag">${Toast.escape(skill)}</span>`).join('');
                const descriptionText = job.description ? Toast.escape(job.description.substring(0, 150)) + '...' : '';
                
                return `
                <div class="job-card" style="background: var(--bg-darker); border-color: var(--primary);">
                    <div class="flex-between" style="margin-bottom: 15px;">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                <span style="background: var(--primary); color: white; padding: 4px 12px; border-radius: 16px; font-size: 0.85rem; font-weight: 600;">
                                    #${index + 1} Best Match
                                </span>
                            </div>
                            <div class="job-title">${Toast.escape(job.title || 'Untitled Position')}</div>
                            <div class="job-company">${Toast.escape(job.company || 'Company')}</div>
                            <div class="job-location">${Toast.escape(job.location || 'Location')}</div>
                        </div>
                    </div>
                    ${salaryText}
                    <div class="job-tags">${skillsTags}</div>
                    ${descriptionText ? `<div class="job-description">${descriptionText}</div>` : ''}
                    <div class="flex-between" style="align-items: center; margin-top: 15px;">
                        <span class="text-muted" style="font-size: 0.85rem;">
                            <span class="job-tag" style="background: var(--primary); color: white;">${Toast.escape(job.source || 'Source')}</span>
                        </span>
                        <button class="btn btn-primary btn-sm" data-url="${Toast.escape(job.url || '')}" onclick="safeOpenUrl(this.dataset.url)">
                            Apply Now
                        </button>
                    </div>
                </div>
                `;
            }).join('');
        }

        function displayJobs(jobs) {
            const container = document.getElementById('jobListings');
            const resultsHeader = document.getElementById('resultsHeader');
            
            // Show empty state if no jobs
            if (jobs.length === 0) {
                resultsHeader.style.display = 'none';
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: var(--text-muted);">
                        <div style="font-size: 3rem; margin-bottom: 20px;"></div>
                        <h2 style="color: var(--text-primary); margin-bottom: 10px;">No Jobs Found</h2>
                        <p style="font-size: 1.1rem; margin-bottom: 20px;">Try adjusting your search criteria</p>
                        <p style="color: var(--text-secondary); max-width: 500px; margin: 0 auto;">
                            We search across The Muse, Remotive, JSearch, and Adzuna to find the best matches for you.
                        </p>
                    </div>
                `;
                document.getElementById('resultsCount').textContent = '0';
                document.getElementById('apiSourcesInfo').textContent = '';
                return;
            }
            
            // Show results header when jobs are found
            resultsHeader.style.display = 'flex';
            
            // Update API sources info
            if (currentResult && currentResult.api_sources) {
                const sources = Object.entries(currentResult.api_sources).map(([name, count]) => `${name} (${count})`).join(', ');
                document.getElementById('apiSourcesInfo').textContent = `from ${sources}`;
            }
            
            container.innerHTML = jobs.map(job => {
                const salaryText = job.salary ? `<div class="job-salary">${Toast.escape(job.salary)}</div>` : '';
                const skillsTags = (job.skills || []).slice(0, 5).map(skill => `<span class="job-tag">${Toast.escape(skill)}</span>`).join('');
                const descriptionText = job.description ? Toast.escape(job.description.substring(0, 200)) + '...' : 'No description available';
                const apiSource = job.source ? `<span class="job-tag" style="background: var(--primary); color: white;">${Toast.escape(job.source)}</span>` : '';
                
                return `
                <div class="job-card">
                    <div class="job-header">
                        <div style="flex: 1;">
                            <div class="job-title">${Toast.escape(job.title || 'Untitled Position')}</div>
                            <div class="job-company">${Toast.escape(job.company || 'Company Not Listed')}</div>
                            <div class="job-location">${Toast.escape(job.location || 'Location Not Specified')}</div>
                        </div>
                    </div>
                    
                    ${salaryText}
                    
                    <div class="job-tags">
                        ${apiSource}
                        ${skillsTags}
                    </div>
                    
                    <div class="job-description">${descriptionText}</div>
                    
                    <div class="flex-between" style="align-items: center;">
                        <span class="text-muted" style="font-size: 0.85rem;">${job.posted_date || 'Recently posted'}</span>
                        <div class="job-actions">
                            <button class="btn btn-secondary btn-sm" data-id="${Toast.escape(job.id || '')}" onclick="saveJob(this.dataset.id)">
                                Save
                            </button>
                            <button class="btn btn-primary btn-sm" data-url="${Toast.escape(job.url || '')}" onclick="safeOpenUrl(this.dataset.url)">
                                Apply Now
                            </button>
                        </div>
                    </div>
                </div>
            `;
            }).join('');

            document.getElementById('resultsCount').textContent = jobs.length;
            document.getElementById('resultsHeader').style.display = 'flex';
        }

        function sortJobs() {
            const sortBy = document.getElementById('sortBy').value;
            let sorted = [...currentJobs];
            
            if (sortBy === 'match') {
                sorted.sort((a, b) => (b.matchScore || 0) - (a.matchScore || 0));
            } else if (sortBy === 'salary') {
                sorted.sort((a, b) => {
                    const aHasSalary = a.salary ? 1 : 0;
                    const bHasSalary = b.salary ? 1 : 0;
                    return bHasSalary - aHasSalary;
                });
            }
            
            displayJobs(sorted);
            Toast.show(`Sorted by ${sortBy}`, 'success');
        }

        async function searchJobs() {
            Loading.show('Searching for matching jobs...');
            
            const query = document.getElementById('jobTitle').value.trim();
            const location = document.getElementById('location').value.trim();
            const country = document.getElementById('country').value;
            const jobType = document.getElementById('jobType').value;
            const datePosted = document.getElementById('datePosted').value;
            const sortBy = document.getElementById('sortByFilter').value;
            const limit = parseInt(document.getElementById('resultsLimit').value);
            const minSalary = document.getElementById('minSalary').value;
            const maxSalary = document.getElementById('maxSalary').value;
            const remoteOnly = document.getElementById('remoteOnly').checked;
            const useResume = document.getElementById('useResume').checked;
            const aiBestMatch = document.getElementById('aiBestMatch').checked;
            
            let effectiveQuery = query;
            if (useResume && !effectiveQuery) {
                const resumeContext = getResumeContext();
                if (resumeContext?.job_title) {
                    effectiveQuery = resumeContext.job_title;
                    document.getElementById('jobTitle').value = effectiveQuery;
                }
            }

            if (!effectiveQuery && !useResume) {
                Loading.hide();
                Toast.show('Please enter a job title or enable "Use My Resume"', 'error');
                return;
            }

            try {
                const token = Auth.getToken();
                
                // Build request body
                const requestBody = {
                    query: effectiveQuery || null,
                    location: location || null,
                    job_type: jobType || null,
                    country: country || null,
                    remote_only: remoteOnly,
                    date_posted: datePosted || null,
                    salary_min: minSalary ? parseInt(minSalary) : null,
                    salary_max: maxSalary ? parseInt(maxSalary) : null,
                    sort_by: sortBy || null,
                    use_resume: useResume,
                    ai_best_match: aiBestMatch,
                    limit: limit,
                    use_all_apis: true
                };
                
                console.log('Search request:', requestBody);
                
                const response = await fetch(`${API_BASE}/api/resume/job-search`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    throw new Error(`Search failed: ${response.statusText}`);
                }

                const result = await response.json();
                currentResult = result;
                Loading.hide();
                
                console.log('Search result:', result);
                
                if (result.success && result.jobs.length > 0) {
                    currentJobs = result.jobs;
                    displayJobs(result.jobs);
                    
                    // Display AI best matches if available
                    if (aiBestMatch && result.ai_best_matches && result.ai_best_matches.length > 0) {
                        displayAIBestMatches(result.ai_best_matches);
                        Toast.show(`Found ${result.total_jobs} jobs with ${result.ai_best_matches.length} AI-ranked matches`, 'success');
                    } else {
                        document.getElementById('aiBestMatchesSection').style.display = 'none';
                        const sourceCount = Object.keys(result.api_sources || {}).length;
                        Toast.show(`Found ${result.total_jobs} jobs from ${sourceCount} source${sourceCount !== 1 ? 's' : ''}`, 'success');
                    }
                    
                    // Show user skills if provided
                    if (result.user_skills && result.user_skills.length > 0) {
                        console.log('Your skills:', result.user_skills);
                    }
                } else if (result.success && result.jobs.length === 0) {
                    currentJobs = [];
                    displayJobs([]);
                    document.getElementById('aiBestMatchesSection').style.display = 'none';
                    Toast.show('No jobs found. Try different search terms or adjust filters.', 'info');
                } else {
                    throw new Error(result.error || 'Unknown error');
                }
            } catch (error) {
                Loading.hide();
                console.error('Search error:', error);
                Toast.show(`Error: ${error.message}`, 'error');
                displayJobs([]);
                document.getElementById('aiBestMatchesSection').style.display = 'none';
            }
        }

        async function saveJob(jobId) {
            try {
                const job = currentJobs.find(j => j.id === jobId);
                if (!job) return;
                
                const token = Auth.getToken();
                const response = await fetch(`${API_BASE}/api/job-matching/update-job-status`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        job_id: jobId,
                        status: 'saved'
                    })
                });
                
                if (response.ok) {
                    Toast.show('Job saved to your tracker!', 'success');
                } else {
                    Toast.show('Failed to save job', 'error');
                }
            } catch (error) {
                console.error('Save error:', error);
                Toast.show('Error saving job', 'error');
            }
        }

        // Initial load - show empty state
        displayJobs([]);
    </script>
</body>
</html>
