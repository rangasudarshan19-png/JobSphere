<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - JobSphere</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="icon" href="images/logo.svg">
    <script src="js/app.js"></script>
    <script src="js/debouncer.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background: #0a0f1e;
            color: #e2e8f0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            line-height: 1.6;
        }

        .admin-container { display: flex; min-height: 100vh; }

        /* ── Sidebar ── */
        .sidebar {
            width: 270px;
            background: linear-gradient(180deg, #131b2e 0%, #0f172a 100%);
            border-right: 1px solid rgba(99,102,241,.12);
            padding: 24px 20px;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 10;
        }
        .sidebar::-webkit-scrollbar { width: 4px; }
        .sidebar::-webkit-scrollbar-track { background: transparent; }
        .sidebar::-webkit-scrollbar-thumb { background: rgba(99,102,241,.25); border-radius: 4px; }

        .content {
            margin-left: 270px;
            flex: 1;
            padding: 40px 48px;
            overflow-y: auto;
            max-height: 100vh;
            background: #0a0f1e;
        }
        .content::-webkit-scrollbar { width: 6px; }
        .content::-webkit-scrollbar-track { background: transparent; }
        .content::-webkit-scrollbar-thumb { background: rgba(99,102,241,.18); border-radius: 6px; }

        .logo { text-align: center; margin-bottom: 8px; }

        .logo-text {
            font-size: 1rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 28px;
            color: #f1f5f9;
            letter-spacing: .02em;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(99,102,241,.12);
        }

        .nav-group-title {
            font-size: .68rem;
            text-transform: uppercase;
            color: #64748b;
            font-weight: 700;
            letter-spacing: .12em;
            margin: 24px 0 8px 8px;
        }

        .nav-item {
            padding: 10px 14px;
            border-radius: 10px;
            cursor: pointer;
            transition: all .25s cubic-bezier(.4,0,.2,1);
            color: #94a3b8;
            border: 1px solid transparent;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: .88rem;
            font-weight: 500;
            margin-bottom: 4px;
        }
        .nav-item:hover {
            background: rgba(99,102,241,.08);
            color: #e2e8f0;
            border-color: rgba(99,102,241,.1);
        }
        .nav-item.active {
            background: linear-gradient(135deg, #6366f1, #4f46e5);
            color: #fff;
            border-color: transparent;
            box-shadow: 0 4px 14px rgba(99,102,241,.3);
        }
        .nav-item svg { opacity: .65; flex-shrink: 0; transition: opacity .2s; }
        .nav-item:hover svg, .nav-item.active svg { opacity: 1; }

        /* ── Header ── */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 36px;
            padding-bottom: 24px;
            border-bottom: 1px solid rgba(99,102,241,.1);
        }
        .title {
            font-size: 1.75rem;
            font-weight: 800;
            background: linear-gradient(135deg, #818cf8, #6366f1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            color: #94a3b8;
            font-size: .9rem;
            background: rgba(30,41,59,.5);
            padding: 8px 16px;
            border-radius: 10px;
            border: 1px solid rgba(51,65,85,.5);
        }

        /* ── Tabs ── */
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn .35s ease-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(12px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        /* ── Cards ── */
        .card {
            background: rgba(30,41,59,.55);
            backdrop-filter: blur(14px);
            -webkit-backdrop-filter: blur(14px);
            border: 1px solid rgba(99,102,241,.1);
            border-radius: 16px;
            padding: 28px;
            margin-bottom: 24px;
            transition: border-color .3s, box-shadow .3s;
        }
        .card:hover {
            border-color: rgba(99,102,241,.2);
            box-shadow: 0 8px 32px rgba(99,102,241,.06);
        }
        .card-title {
            font-size: 1.15rem;
            font-weight: 700;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #e2e8f0;
        }

        /* ── Stats ── */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 28px;
        }
        .stat-box {
            background: rgba(15,23,42,.8);
            border: 1px solid rgba(99,102,241,.1);
            border-radius: 14px;
            padding: 24px;
            text-align: center;
            transition: all .3s ease;
            position: relative;
            overflow: hidden;
        }
        .stat-box::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 3px;
            background: linear-gradient(90deg, #6366f1, #818cf8);
            opacity: 0;
            transition: opacity .3s;
        }
        .stat-box:hover {
            border-color: rgba(99,102,241,.22);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(99,102,241,.1);
        }
        .stat-box:hover::before { opacity: 1; }
        .stat-number {
            font-size: 2.2rem;
            font-weight: 800;
            background: linear-gradient(135deg, #818cf8, #6366f1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 6px;
            line-height: 1.2;
        }
        .stat-text {
            color: #94a3b8;
            font-size: .82rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: .04em;
        }

        /* ── Buttons ── */
        .button-group { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 24px; }
        .btn {
            padding: 10px 18px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            font-size: .85rem;
            transition: all .25s cubic-bezier(.4,0,.2,1);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            letter-spacing: .01em;
        }
        .btn-primary {
            background: linear-gradient(135deg, #6366f1, #4f46e5);
            color: #fff;
            box-shadow: 0 2px 10px rgba(99,102,241,.25);
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #818cf8, #6366f1);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(99,102,241,.35);
        }
        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: #fff;
            box-shadow: 0 2px 8px rgba(239,68,68,.2);
        }
        .btn-danger:hover {
            background: linear-gradient(135deg, #f87171, #ef4444);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(239,68,68,.3);
        }
        .btn-success {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: #fff;
            box-shadow: 0 2px 8px rgba(34,197,94,.2);
        }
        .btn-success:hover {
            background: linear-gradient(135deg, #4ade80, #22c55e);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(34,197,94,.3);
        }
        .btn-secondary {
            background: transparent;
            color: #818cf8;
            border: 1px solid rgba(99,102,241,.3);
        }
        .btn-secondary:hover {
            background: rgba(99,102,241,.08);
            border-color: rgba(99,102,241,.5);
            transform: translateY(-2px);
        }
        .btn-info {
            background: linear-gradient(135deg, #0ea5e9, #0284c7);
            color: #fff;
            box-shadow: 0 2px 8px rgba(14,165,233,.2);
        }
        .btn-info:hover {
            background: linear-gradient(135deg, #38bdf8, #0ea5e9);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(14,165,233,.3);
        }
        .btn-warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: #fff;
            box-shadow: 0 2px 8px rgba(245,158,11,.2);
        }
        .btn-warning:hover {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(245,158,11,.3);
        }

        /* ── Forms ── */
        .form-group { margin-bottom: 20px; }
        label {
            display: block;
            margin-bottom: 8px;
            color: #94a3b8;
            font-weight: 600;
            font-size: .82rem;
            text-transform: uppercase;
            letter-spacing: .04em;
        }
        input, textarea, select {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid rgba(51,65,85,.6);
            border-radius: 10px;
            background: rgba(15,23,42,.6);
            color: #f1f5f9;
            font-family: inherit;
            font-size: .9rem;
            transition: all .25s ease;
        }
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99,102,241,.15);
            background: rgba(15,23,42,.8);
        }
        input::placeholder, textarea::placeholder { color: #475569; }

        /* ── Tables ── */
        .table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 12px;
        }
        .table thead { background: rgba(15,23,42,.8); }
        .table th {
            padding: 14px 16px;
            text-align: left;
            font-weight: 700;
            color: #94a3b8;
            font-size: .78rem;
            text-transform: uppercase;
            letter-spacing: .06em;
            border-bottom: 2px solid rgba(99,102,241,.12);
        }
        .table td {
            padding: 14px 16px;
            border-bottom: 1px solid rgba(51,65,85,.35);
            font-size: .9rem;
        }
        .table tbody tr { transition: background .2s; }
        .table tbody tr:hover { background: rgba(99,102,241,.06); }

        /* ── Badges ── */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: .75rem;
            font-weight: 600;
            letter-spacing: .02em;
        }
        .badge-success { background: rgba(34,197,94,.12); color: #4ade80; }
        .badge-danger  { background: rgba(239,68,68,.12); color: #f87171; }

        /* ── Status dot ── */
        .status-dot {
            display: inline-block;
            width: 8px; height: 8px;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }
        .status-dot.online { background: #22c55e; box-shadow: 0 0 8px rgba(34,197,94,.4); }
        @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: .5; } }

        /* ── Alerts ── */
        .alert {
            padding: 16px 20px;
            border-radius: 12px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: .9rem;
            font-weight: 500;
        }
        .alert-success { background: rgba(34,197,94,.08); border: 1px solid rgba(34,197,94,.2); color: #4ade80; }
        .alert-info    { background: rgba(99,102,241,.08); border: 1px solid rgba(99,102,241,.2); color: #818cf8; }
        .alert-danger  { background: rgba(239,68,68,.08); border: 1px solid rgba(239,68,68,.2); color: #f87171; }

        /* ── Modal ── */
        .modal-overlay {
            position: fixed; inset: 0;
            background: rgba(2,6,23,.8);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal {
            background: #131b2e;
            border: 1px solid rgba(99,102,241,.15);
            border-radius: 16px;
            width: 520px;
            max-width: calc(100% - 32px);
            box-shadow: 0 24px 48px rgba(2,6,23,.7), 0 0 0 1px rgba(99,102,241,.05);
            animation: modalIn .2s ease-out;
        }
        @keyframes modalIn {
            from { opacity: 0; transform: scale(.95) translateY(10px); }
            to   { opacity: 1; transform: scale(1) translateY(0); }
        }
        .modal-header {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 20px 24px;
            border-bottom: 1px solid rgba(51,65,85,.5);
        }
        .modal-title { font-size: 1.1rem; font-weight: 700; color: #f1f5f9; }
        .modal-body { padding: 20px 24px; color: #94a3b8; line-height: 1.7; }
        .modal-body .danger { color: #f87171; font-weight: 600; }
        .modal-list { margin-top: 12px; margin-left: 18px; }
        .modal-list li { margin-bottom: 4px; }
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            padding: 16px 24px;
            border-top: 1px solid rgba(51,65,85,.5);
        }

        .logout-btn {
            margin-top: 32px;
            padding-top: 16px;
            border-top: 1px solid rgba(51,65,85,.3);
        }

        @media (max-width: 768px) {
            .sidebar { width: 100%; position: static; height: auto; margin-bottom: 20px; }
            .content { margin-left: 0; padding: 20px; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="logo"><img src="images/logo.svg" alt="" width="28" height="28"></div>
            <div class="logo-text">Admin Panel</div>

            <div>
                <div class="nav-group-title">Dashboard</div>
                <div class="nav-item active" onclick="switchTab(event, 'overview')"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg> Overview</div>
                <div class="nav-item" onclick="switchTab(event, 'api-status')"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg> API Status</div>

                <div class="nav-group-title">Users</div>
                <div class="nav-item" onclick="switchTab(event, 'users')"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg> All Users</div>
                <div class="nav-item" onclick="switchTab(event, 'manage-users')"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg> Manage Users</div>

                <div class="nav-group-title">Applications</div>
                <div class="nav-item" onclick="switchTab(event, 'applications')"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg> Applications</div>

                <div class="nav-group-title">Communication</div>
                <div class="nav-item" onclick="switchTab(event, 'announcements')"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 17H2a3 3 0 0 0 3-3V9a7 7 0 0 1 14 0v5a3 3 0 0 0 3 3zm-8.27 4a2 2 0 0 1-3.46 0"/></svg> Announcements</div>

                <div class="nav-group-title">Audit</div>
                <div class="nav-item" onclick="switchTab(event, 'audit-logs')"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg> Audit Logs</div>

                <div class="nav-group-title">Quick Links</div>
                <div class="nav-item" onclick="goToSwagger()"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg> Swagger API Docs</div>

                <div class="logout-btn">
                    <button class="btn btn-danger" style="width: 100%;" onclick="logout()">Logout</button>
                </div>
            </div>
        </div>

        <!-- Content -->
        <div class="content">
            <div class="header">
                <h1 class="title">JobSphere Admin Panel</h1>
                <div class="user-info">
                    <span id="adminName">Loading...</span>
                    <span>•</span>
                    <span id="adminEmail">admin@jobtracker.com</span>
                </div>
            </div>

            <!-- Overview Tab -->
            <div id="overview" class="tab-content active">
                <div class="card">
                    <div class="card-title">System Overview</div>
                    <div class="stats-grid">
                        <div class="stat-box">
                            <div class="stat-number" id="totalUsers">-</div>
                            <div class="stat-text">Total Users</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-number" id="activeUsers">-</div>
                            <div class="stat-text">Active Users</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-number" id="totalApps">-</div>
                            <div class="stat-text">Job Applications</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-number" id="activeApps">-</div>
                            <div class="stat-text">Active Applications</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">Swagger Authorization Token</div>
                    <p style="color:#64748b;font-size:.82rem;margin-bottom:16px;">
                        Copy this token to authorize API requests in Swagger UI
                    </p>
                    <div style="background:rgba(15,23,42,.7);padding:16px;border-radius:10px;margin-bottom:16px;border:1px solid rgba(51,65,85,.4);">
                        <code id="swaggerToken" style="color:#4ade80;font-size:.75rem;word-break:break-all;display:block;line-height:1.7;font-family:'JetBrains Mono',monospace;">
                            Loading token...
                        </code>
                    </div>
                    <div class="button-group">
                        <button class="btn btn-primary" onclick="copySwaggerToken()">Copy Token</button>
                        <button class="btn btn-secondary" onclick="goToSwagger()">Open Swagger & Authorize</button>
                    </div>
                    <div id="tokenCopyMsg" style="margin-top: 10px; color: #22c55e; font-size: 13px; display: none;">
                        Token copied to clipboard!
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">Quick Actions</div>
                    <div class="button-group">
                        <button class="btn btn-primary" onclick="switchTabDirect('announcements')">Create Announcement</button>
                        <button class="btn btn-secondary" onclick="switchTabDirect('users')">View All Users</button>
                        <button class="btn btn-secondary" onclick="switchTabDirect('audit-logs')">View Audit Logs</button>
                    </div>
                </div>
            </div>

            <!-- API Status Tab -->
            <div id="api-status" class="tab-content">
                <div class="card">
                    <div class="card-title">API Status & Health Check</div>
                    <div class="button-group">
                        <button class="btn btn-primary" onclick="checkAllApis()">✓ Check All APIs</button>
                        <button class="btn btn-secondary" onclick="goToSwagger()">Open Swagger UI</button>
                    </div>
                    <div id="apiStatusContainer"></div>
                </div>
            </div>

            <!-- Users Tab -->
            <div id="users" class="tab-content">
                <div class="card">
                    <div class="card-title">All Users</div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Email</th>
                                <th>Status</th>
                                <th>Admin</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <tr><td colspan="4">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Manage Users Tab -->
            <div id="manage-users" class="tab-content">
                <div class="card">
                    <div class="card-title">User Management</div>
                    <div class="form-group">
                        <label>User Email</label>
                        <input type="email" id="userEmail" placeholder="Enter user email">
                    </div>
                    <div class="button-group">
                        <button id="suspendBtn" class="btn btn-primary" onclick="suspendUser()">Suspend User</button>
                        <button id="activateBtn" class="btn btn-success" onclick="activateUser()">Activate User</button>
                        <button id="deleteBtn" class="btn btn-danger" onclick="deleteUser()">Delete User</button>
                    </div>
                    <div class="button-group" style="margin-top: 15px; border-top: 1px solid #e2e8f0; padding-top: 15px;">
                        <button id="grantAdminBtn" class="btn btn-info" onclick="grantAdminPower()">Grant Admin Power</button>
                        <button id="revokeAdminBtn" class="btn btn-warning" onclick="revokeAdminPower()">Revoke Admin Power</button>
                    </div>
                    <div id="userManagementResult"></div>
                </div>
            </div>

            <!-- Applications Tab -->
            <div id="applications" class="tab-content">
                <div class="card">
                    <div class="card-title">Job Applications</div>
                    <div id="appsList">
                        <p style="color: #cbd5e1;">Loading applications...</p>
                    </div>
                </div>
            </div>

            <!-- Announcements Tab -->
            <div id="announcements" class="tab-content">
                <div class="card">
                    <div class="card-title">Create Announcement</div>
                    <div class="form-group">
                        <label>Title</label>
                        <input type="text" id="announcementTitle" placeholder="Announcement title">
                    </div>
                    <div class="form-group">
                        <label>Content</label>
                        <textarea id="announcementContent" placeholder="Announcement content..." rows="6"></textarea>
                    </div>
                    <button id="announceBtn" class="btn btn-primary" onclick="createAnnouncement()">Publish Announcement</button>
                    <div id="announcementResult" style="margin-top: 20px;"></div>
                </div>
            </div>

            <!-- Audit Logs Tab -->
            <div id="audit-logs" class="tab-content">
                <div class="card">
                    <div class="card-title">Audit Logs</div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>Admin</th>
                                <th>Action</th>
                                <th>Target</th>
                            </tr>
                        </thead>
                        <tbody id="auditLogsBody">
                            <tr><td colspan="4">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div id="confirmOverlay" class="modal-overlay" role="dialog" aria-modal="true" aria-hidden="true">
        <div class="modal" role="document">
            <div class="modal-header">
                <div style="background:#fee2e2;color:#b91c1c;border:1px solid #fecaca;border-radius:8px;width:36px;height:36px;display:flex;align-items:center;justify-content:center;"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#b91c1c" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg></div>
                <div class="modal-title" id="confirmTitle">Confirm Action</div>
            </div>
            <div class="modal-body">
                <div id="confirmMessage">Are you sure you want to proceed?</div>
                <ul class="modal-list" id="confirmList"></ul>
                <div id="confirmNote" class="danger" style="margin-top:12px;">This action cannot be undone.</div>
            </div>
            <div class="modal-footer">
                <button id="confirmCancel" class="btn btn-secondary">Cancel</button>
                <button id="confirmOk" class="btn btn-danger">Delete</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = API_BASE + '/api';
        
        // Enhanced authentication check with retry logic
        function checkAuthAndInit() {
            // Ensure Auth class is available
            if (typeof Auth === 'undefined') {
                console.log('Auth class not ready, retrying...');
                setTimeout(checkAuthAndInit, 100);
                return;
            }
            
            // Check if authenticated
            if (!Auth.isAuthenticated()) {
                console.log('Not authenticated, redirecting to login');
                window.location.href = 'login.html';
                return;
            }
            
            console.log('Admin authenticated, initializing dashboard');
            // Initialize dashboard once auth is confirmed
            initDashboard();
        }
        
        // Start auth check when DOM is ready
        window.addEventListener('DOMContentLoaded', checkAuthAndInit);

        function switchTab(event, tabName) {
            event?.preventDefault?.();
            
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });

            document.getElementById(tabName).classList.add('active');
            event?.target?.classList.add('active');

            if (tabName === 'users') loadAllUsers();
            if (tabName === 'audit-logs') loadAuditLogs();
            if (tabName === 'api-status') checkAllApis();
            if (tabName === 'applications') loadApplicationsList();
        }

        function switchTabDirect(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });

            document.getElementById(tabName).classList.add('active');
            
            // Find and activate the corresponding nav item
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                if (item.textContent.includes(tabName === 'announcements' ? 'Announcements' : tabName === 'users' ? 'All Users' : 'Audit')) {
                    item.classList.add('active');
                }
            });

            if (tabName === 'users') loadAllUsers();
            if (tabName === 'audit-logs') loadAuditLogs();
            if (tabName === 'announcements') document.getElementById('announcementTitle').focus();
        }

        function goToSwagger() {
            window.open(API_BASE + '/docs', '_blank');
        }

        function copySwaggerToken() {
            const token = Auth.getToken();
            if (token) {
                navigator.clipboard.writeText(token).then(() => {
                    const msg = document.getElementById('tokenCopyMsg');
                    msg.style.display = 'block';
                    setTimeout(() => {
                        msg.style.display = 'none';
                    }, 3000);
                }).catch(() => {
                    Toast.show('Failed to copy. Please copy manually.', 'error');
                });
            } else {
                Toast.show('No token found. Please login again.', 'error');
            }
        }

        function updateSwaggerToken() {
            const token = Auth.getToken();
            const tokenElement = document.getElementById('swaggerToken');
            if (token) {
                tokenElement.textContent = token;
            } else {
                tokenElement.textContent = 'No token available. Please login again.';
                tokenElement.style.color = '#ef4444';
            }
        }

        async function initDashboard() {
            try {
                const authToken = Auth.getToken();
                if (!authToken) {
                    console.error('No token available');
                    window.location.href = 'login.html';
                    return;
                }
                
                const response = await fetch(`${API_URL}/auth/me`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await response.json();
                document.getElementById('adminName').textContent = data.full_name || 'Admin';
                document.getElementById('adminEmail').textContent = data.email;
                
                // Update swagger token display
                updateSwaggerToken();
                
                await loadStats();
            } catch (error) {
                console.error('Error initializing dashboard:', error);
            }
        }

        async function loadStats() {
            try {
                const authToken = Auth.getToken();
                const response = await fetch(`${API_URL}/admin/dashboard`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await response.json();
                
                document.getElementById('totalUsers').textContent = data.total_users || 0;
                document.getElementById('activeUsers').textContent = data.active_users || 0;
                document.getElementById('totalApps').textContent = data.total_applications || 0;
                document.getElementById('activeApps').textContent = data.active_applications || 0;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function checkAllApis() {
            const container = document.getElementById('apiStatusContainer');
            container.innerHTML = '<p style="color: #cbd5e1;">Checking API status...</p>';

            const endpoints = [
                { name: 'Admin Dashboard', path: '/api/admin/dashboard' },
                { name: 'Get Users', path: '/api/admin/users/search' },
                { name: 'Get Audit Logs', path: '/api/admin/audit-logs' }
            ];

            let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-top: 16px;">';
            
            for (const endpoint of endpoints) {
                const status = await checkEndpoint(endpoint.path);
                html += `
                    <div style="background:rgba(15,23,42,.8);border:1px solid rgba(99,102,241,.1);border-radius:12px;padding:20px;transition:border-color .3s;">
                        <div style="font-weight:700;margin-bottom:10px;color:#e2e8f0;font-size:.95rem;">${endpoint.name}</div>
                        <div style="display:flex;align-items:center;gap:8px;">
                            <span class="status-dot ${status ? 'online' : ''}"></span>
                            <span style="color:${status ? '#4ade80' : '#f87171'};font-weight:600;font-size:.85rem;">${status ? 'Online' : 'Offline'}</span>
                        </div>
                    </div>
                `;
            }
            
            html += '</div>';
            container.innerHTML = html;
        }

        async function checkEndpoint(path) {
            try {
                const authToken = Auth.getToken();
                const response = await Promise.race([
                    fetch(`${API_BASE}${path}`, {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    }),
                    new Promise((_, reject) => setTimeout(() => reject('timeout'), 5000))
                ]);
                return response.ok || response.status < 500;
            } catch {
                return false;
            }
        }

        async function loadAllUsers() {
            try {
                const authToken = Auth.getToken();
                const response = await fetch(`${API_URL}/admin/users/search`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const users = await response.json();
                const tbody = document.getElementById('usersTableBody');
                
                if (!users || users.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4">No users found</td></tr>';
                    return;
                }
                
                tbody.innerHTML = users.map(user => `
                    <tr>
                        <td>${user.id}</td>
                        <td>${Toast.escape(user.email)}</td>
                        <td><span class="badge badge-${user.is_suspended ? 'danger' : 'success'}">${user.is_suspended ? 'Suspended' : 'Active'}</span></td>
                        <td>${user.is_admin ? 'Yes' : 'No'}</td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading users:', error);
                document.getElementById('usersTableBody').innerHTML = `<tr><td colspan="4" style="color: red;">Error: ${error.message}</td></tr>`;
            }
        }

        async function loadApplicationsList() {
            try {
                const authToken = Auth.getToken();
                const response = await fetch(`${API_URL}/applications`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const applications = await response.json();
                const container = document.getElementById('appsList');

                if (!applications || applications.length === 0) {
                    container.innerHTML = '<p style="color: #cbd5e1; text-align: center; padding: 20px;">No job applications found</p>';
                    return;
                }

                let html = '<div style="display: grid; gap: 16px;">';
                
                applications.forEach(app => {
                    const appliedDate = new Date(app.applied_date).toLocaleDateString();
                    const statusColor = {
                        'applied': '#3b82f6',
                        'interviewed': '#8b5cf6',
                        'offer': '#10b981',
                        'rejected': '#ef4444',
                        'pending': '#f59e0b'
                    }[app.status?.toLowerCase()] || '#64748b';

                    html += `
                        <div style="background:rgba(15,23,42,.7);border:1px solid rgba(99,102,241,.1);border-radius:14px;padding:20px;transition:border-color .3s;">
                            <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:14px;">
                                <div>
                                    <div style="font-weight:700;color:#e2e8f0;font-size:1rem;">${Toast.escape(app.job_title)}</div>
                                    <div style="color:#64748b;font-size:.85rem;margin-top:4px;font-weight:500;">${Toast.escape(app.company?.name || 'Unknown Company')}</div>
                                </div>
                                <span style="background:${statusColor};color:#fff;padding:5px 14px;border-radius:8px;font-size:.75rem;font-weight:600;letter-spacing:.02em;">
                                    ${app.status || 'Unknown'}
                                </span>
                            </div>
                            <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:14px;font-size:.82rem;color:#94a3b8;">
                                <div><strong>Location:</strong> ${Toast.escape(app.location || 'Not specified')}</div>
                                <div><strong>Type:</strong> ${app.job_type || 'Not specified'}</div>
                                <div><strong>Applied:</strong> ${appliedDate}</div>
                                ${app.salary_range ? `<div><strong>Salary:</strong> ${app.salary_range}</div>` : ''}
                            </div>
                            ${app.notes ? `<div style="margin-top:14px;padding-top:14px;border-top:1px solid rgba(51,65,85,.4);color:#64748b;font-size:.82rem;"><strong>Notes:</strong> ${Toast.escape(app.notes)}</div>` : ''}
                        </div>
                    `;
                });

                html += '</div>';
                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading applications:', error);
                document.getElementById('appsList').innerHTML = `<p style="color: #ef4444;">Error loading applications: ${error.message}</p>`;
            }
        }

        async function loadAuditLogs() {
            try {
                const authToken = Auth.getToken();
                const response = await fetch(`${API_URL}/admin/audit-logs?limit=50`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await response.json();
                const tbody = document.getElementById('auditLogsBody');

                const logs = Array.isArray(data) ? data : (data?.logs || []);

                if (!logs.length) {
                    tbody.innerHTML = '<tr><td colspan="4">No audit logs found</td></tr>';
                    return;
                }

                tbody.innerHTML = logs.slice(0, 20).map(log => `
                    <tr>
                        <td>${new Date(log.timestamp).toLocaleString()}</td>
                        <td>${Toast.escape(log.admin_email || '-')}</td>
                        <td>${Toast.escape(log.action || '-')}</td>
                        <td>${Toast.escape(log.target_type || '-')}</td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading audit logs:', error);
            }
        }

        async function createAnnouncement() {
            const title = document.getElementById('announcementTitle').value;
            const content = document.getElementById('announcementContent').value;

            if (!title || !content) {
                Toast.show('Please fill in all fields', 'warning');
                return;
            }

            // Use debouncer to prevent multiple rapid clicks
            await debouncer.executeWithButton('announceBtn', async () => {
                const authToken = Auth.getToken();
                const response = await fetch(`${API_URL}/admin/announcements`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ title, content, expires_in_hours: 24 })
                });

                if (response.ok) {
                    document.getElementById('announcementResult').innerHTML = '<div class="alert alert-success">Announcement published successfully!</div>';
                    document.getElementById('announcementTitle').value = '';
                    document.getElementById('announcementContent').value = '';
                    Toast.show('Announcement published', 'success');
                } else {
                    throw new Error('Failed to create announcement');
                }
            }, 3000).catch(error => {
                document.getElementById('announcementResult').innerHTML = '<div class="alert alert-danger">Error: ' + error.message + '</div>';
            });
        }

        async function suspendUser() {
            const email = document.getElementById('userEmail').value;
            if (!email) {
                Toast.show('Please enter an email address', 'warning');
                return;
            }

            // Use debouncer to prevent multiple rapid clicks
            await debouncer.executeWithButton('suspendBtn', async () => {
                const authToken = Auth.getToken();
                
                // First, search for the user by email
                const searchResponse = await fetch(`${API_URL}/admin/users/search?email=${encodeURIComponent(email)}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (!searchResponse.ok) {
                    throw new Error('Failed to search users');
                }
                
                const users = await searchResponse.json();
                if (!users || users.length === 0) {
                    throw new Error('User not found');
                }
                
                const userId = users[0].id;
                
                // Now suspend the user
                const suspendResponse = await fetch(`${API_URL}/admin/users/${userId}/suspend?action=suspend`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (suspendResponse.ok) {
                    document.getElementById('userManagementResult').innerHTML = '<div class="alert alert-success">User suspended successfully!</div>';
                    document.getElementById('userEmail').value = '';
                    Toast.show('User account suspended', 'success');
                } else {
                    throw new Error('Failed to suspend user');
                }
            }, 3000).catch(error => {
                document.getElementById('userManagementResult').innerHTML = '<div class="alert alert-danger">Error: ' + error.message + '</div>';
            });
        }

        async function activateUser() {
            const email = document.getElementById('userEmail').value;
            if (!email) {
                Toast.show('Please enter an email address', 'warning');
                return;
            }

            // Use debouncer to prevent multiple rapid clicks
            await debouncer.executeWithButton('activateBtn', async () => {
                const authToken = Auth.getToken();
                
                // First, search for the user by email
                const searchResponse = await fetch(`${API_URL}/admin/users/search?email=${encodeURIComponent(email)}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (!searchResponse.ok) {
                    throw new Error('Failed to search users');
                }
                
                const users = await searchResponse.json();
                if (!users || users.length === 0) {
                    throw new Error('User not found');
                }
                
                const userId = users[0].id;
                
                // Now activate the user
                const activateResponse = await fetch(`${API_URL}/admin/users/${userId}/suspend?action=activate`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (activateResponse.ok) {
                    document.getElementById('userManagementResult').innerHTML = '<div class="alert alert-success">User activated successfully!</div>';
                    document.getElementById('userEmail').value = '';
                    Toast.show('User account activated', 'success');
                } else {
                    throw new Error('Failed to activate user');
                }
            }, 3000).catch(error => {
                document.getElementById('userManagementResult').innerHTML = '<div class="alert alert-danger">Error: ' + error.message + '</div>';
            });
        }

        async function deleteUser() {
            const email = document.getElementById('userEmail').value;
            if (!email) {
                Toast.show('Please enter an email address', 'warning');
                return;
            }

            // Professional confirmation modal
            const confirmed = await showConfirmDialog({
                title: 'Delete User',
                message: `Are you sure you want to delete user "${email}"?`,
                list: [
                    'User account',
                    'All job applications',
                    'All associated data'
                ],
                confirmText: 'Delete User',
                cancelText: 'Cancel',
                dangerNote: 'This action cannot be undone.'
            });

            if (!confirmed) {
                return;
            }

            // Use debouncer to prevent multiple rapid clicks
            await debouncer.executeWithButton('deleteBtn', async () => {
                const authToken = Auth.getToken();
                
                // First, search for the user by email
                const searchResponse = await fetch(`${API_URL}/admin/users/search?email=${encodeURIComponent(email)}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (!searchResponse.ok) {
                    throw new Error('Failed to search users');
                }
                
                const users = await searchResponse.json();
                if (!users || users.length === 0) {
                    throw new Error('User not found');
                }
                
                const userId = users[0].id;
                const userName = users[0].full_name || users[0].email;
                
                // Now delete the user
                const deleteResponse = await fetch(`${API_URL}/admin/users/${userId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (deleteResponse.ok) {
                    const result = await deleteResponse.json();
                    document.getElementById('userManagementResult').innerHTML = `<div class="alert alert-success">User "${userName}" deleted successfully!</div>`;
                    document.getElementById('userEmail').value = '';
                    Toast.show('User deleted', 'success');
                } else {
                    const error = await deleteResponse.json();
                    throw new Error(error.detail || 'Unknown error');
                }
            }, 3000).catch(error => {
                document.getElementById('userManagementResult').innerHTML = '<div class="alert alert-danger">Error: ' + error.message + '</div>';
            });
        }

        async function grantAdminPower() {
            const email = document.getElementById('userEmail').value;
            if (!email) {
                Toast.show('Please enter an email address', 'warning');
                return;
            }

            // Use debouncer to prevent multiple rapid clicks
            await debouncer.executeWithButton('grantAdminBtn', async () => {
                const authToken = Auth.getToken();
                
                // First, search for the user by email
                const searchResponse = await fetch(`${API_URL}/admin/users/search?email=${encodeURIComponent(email)}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (!searchResponse.ok) {
                    throw new Error('Failed to search users');
                }
                
                const users = await searchResponse.json();
                if (!users || users.length === 0) {
                    throw new Error('User not found');
                }
                
                const userId = users[0].id;
                
                // Grant admin power
                const grantResponse = await fetch(`${API_URL}/admin/users/${userId}/make-admin`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (grantResponse.ok) {
                    document.getElementById('userManagementResult').innerHTML = '<div class="alert alert-success">Admin power granted successfully!</div>';
                    document.getElementById('userEmail').value = '';
                    Toast.show('Admin power granted', 'success');
                } else {
                    throw new Error('Failed to grant admin power');
                }
            }, 3000).catch(error => {
                document.getElementById('userManagementResult').innerHTML = '<div class="alert alert-danger">Error: ' + error.message + '</div>';
            });
        }

        async function revokeAdminPower() {
            const email = document.getElementById('userEmail').value;
            if (!email) {
                Toast.show('Please enter an email address', 'warning');
                return;
            }

            // Use debouncer to prevent multiple rapid clicks
            await debouncer.executeWithButton('revokeAdminBtn', async () => {
                const authToken = Auth.getToken();
                
                // First, search for the user by email
                const searchResponse = await fetch(`${API_URL}/admin/users/search?email=${encodeURIComponent(email)}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (!searchResponse.ok) {
                    throw new Error('Failed to search users');
                }
                
                const users = await searchResponse.json();
                if (!users || users.length === 0) {
                    throw new Error('User not found');
                }
                
                const userId = users[0].id;
                
                // Revoke admin power
                const revokeResponse = await fetch(`${API_URL}/admin/users/${userId}/remove-admin`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (revokeResponse.ok) {
                    document.getElementById('userManagementResult').innerHTML = '<div class="alert alert-success">Admin power revoked successfully!</div>';
                    document.getElementById('userEmail').value = '';
                    Toast.show('Admin power revoked', 'success');
                } else {
                    throw new Error('Failed to revoke admin power');
                }
            }, 3000).catch(error => {
                document.getElementById('userManagementResult').innerHTML = '<div class="alert alert-danger">Error: ' + error.message + '</div>';
            });
        }

        // Reusable confirmation modal
        function showConfirmDialog({ title, message, list = [], confirmText = 'Confirm', cancelText = 'Cancel', dangerNote = '' }) {
            return new Promise(resolve => {
                const overlay = document.getElementById('confirmOverlay');
                const titleEl = document.getElementById('confirmTitle');
                const messageEl = document.getElementById('confirmMessage');
                const listEl = document.getElementById('confirmList');
                const noteEl = document.getElementById('confirmNote');
                const okBtn = document.getElementById('confirmOk');
                const cancelBtn = document.getElementById('confirmCancel');

                titleEl.textContent = title || 'Confirm Action';
                messageEl.textContent = message || 'Are you sure you want to proceed?';
                listEl.innerHTML = list.map(item => `<li>${Toast.escape(item)}</li>`).join('');
                noteEl.textContent = dangerNote || '';
                okBtn.textContent = confirmText;
                cancelBtn.textContent = cancelText;

                const close = (result) => {
                    overlay.style.display = 'none';
                    overlay.setAttribute('aria-hidden', 'true');
                    okBtn.removeEventListener('click', onOk);
                    cancelBtn.removeEventListener('click', onCancel);
                    document.removeEventListener('keydown', onKey);
                    resolve(result);
                };

                const onOk = () => close(true);
                const onCancel = () => close(false);
                const onKey = (e) => {
                    if (e.key === 'Escape') close(false);
                };

                okBtn.addEventListener('click', onOk);
                cancelBtn.addEventListener('click', onCancel);
                document.addEventListener('keydown', onKey);

                overlay.style.display = 'flex';
                overlay.setAttribute('aria-hidden', 'false');
                okBtn.focus();
            });
        }

        function logout() {
            Auth.removeToken();
            window.location.href = 'login.html';
        }
    </script>
</body>
</html>
