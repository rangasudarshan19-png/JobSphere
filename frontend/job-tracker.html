<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Tracker ‚Äî JobSphere</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="icon" href="images/logo.svg">
    <style>
        .hero-section{
            background:linear-gradient(135deg,rgba(99,102,241,.08),rgba(139,92,246,.08));
            border:1px solid var(--border-color);border-radius:var(--radius-2xl);
            padding:var(--spacing-2xl);margin-bottom:var(--spacing-xl);
        }
        .hero-section h1{margin:0 0 var(--spacing-xs)}
        .hero-section p{color:var(--text-muted);max-width:680px;margin:0}
        .filters{display:flex;flex-wrap:wrap;gap:var(--spacing-sm);margin-bottom:var(--spacing-xl)}
        .filter-chip{
            padding:0.375rem 0.875rem;border-radius:var(--radius-full);
            background:var(--bg-secondary);border:1px solid var(--border-color);
            color:var(--text-secondary);font-size:0.875rem;font-weight:500;
            cursor:pointer;transition:var(--transition-fast);
        }
        .filter-chip:hover,.filter-chip.active{background:rgba(99,102,241,0.15);border-color:var(--primary);color:var(--primary-light)}
        .board{display:grid;grid-template-columns:repeat(auto-fill,minmax(360px,1fr));gap:var(--spacing-lg)}
        @media(max-width:640px){.board{grid-template-columns:1fr}}
        .tracker-card{
            background:var(--bg-card);border:1px solid var(--border-color);
            border-radius:var(--radius-xl);padding:var(--spacing-xl);
            display:flex;flex-direction:column;gap:var(--spacing-md);
            transition:var(--transition-base);
        }
        .tracker-card:hover{border-color:rgba(99,102,241,0.25);box-shadow:var(--shadow-md)}
        .tracker-card-head{display:flex;justify-content:space-between;gap:var(--spacing-sm)}
        .tracker-title{font-size:1.05rem;font-weight:700;color:var(--text-primary);margin:0}
        .tracker-meta{color:var(--text-muted);font-size:0.875rem;display:flex;gap:8px;flex-wrap:wrap}
        .tracker-chips{display:flex;gap:var(--spacing-xs);flex-wrap:wrap}
        .tracker-chip{
            padding:0.2rem 0.5rem;border-radius:var(--radius-sm);font-size:0.8125rem;
            background:var(--bg-secondary);color:var(--text-secondary);border:1px solid var(--border-color);
        }
        .tracker-chip.match{background:rgba(99,102,241,0.1);color:var(--primary-light);border-color:rgba(99,102,241,0.15)}
        .tracker-chip.salary{background:rgba(16,185,129,0.08);color:var(--success);border-color:rgba(16,185,129,0.15)}
        .status-pills{display:flex;gap:var(--spacing-sm);flex-wrap:wrap;align-items:center}
        .pill{
            padding:0.35rem 0.65rem;border-radius:var(--radius-lg);
            font-weight:600;font-size:0.8125rem;display:inline-flex;align-items:center;gap:4px;
            cursor:pointer;user-select:none;transition:var(--transition-fast);
        }
        .pill.saved{background:rgba(99,102,241,0.1);color:var(--primary-light);border:1px solid rgba(99,102,241,0.2)}
        .pill.applied{background:rgba(16,185,129,0.1);color:var(--success);border:1px solid rgba(16,185,129,0.2)}
        .pill.ghost{background:var(--bg-secondary);color:var(--text-muted);border:1px solid var(--border-color)}
        .tracker-notes{
            width:100%;min-height:60px;background:var(--bg-secondary);
            border:1px solid var(--border-color);color:var(--text-primary);
            border-radius:var(--radius-lg);padding:var(--spacing-sm);
            resize:vertical;font-family:inherit;font-size:0.875rem;
            transition:border-color .2s;
        }
        .tracker-notes:focus{outline:none;border-color:var(--primary)}
        .tracker-actions{display:flex;gap:var(--spacing-sm);flex-wrap:wrap}
        .skeleton-tracker{height:220px;border-radius:var(--radius-xl);margin-bottom:var(--spacing-lg)}
    </style>
</head>
<body>
    <a href="#main" class="skip-link">Skip to content</a>

    <!-- Navbar -->
    <nav class="navbar">
        <div class="navbar-container">
            <a class="navbar-brand" href="index.html"><img src="images/logo.svg" alt="" width="28" height="28"> JobSphere</a>
            <div class="navbar-end">
                <a href="job-search.html" class="btn btn-ghost btn-sm">üîç Search</a>
                <a href="dashboard.html" class="btn btn-ghost btn-sm">‚Üê Dashboard</a>
                <button class="btn btn-ghost btn-sm" onclick="Auth.logout()">Logout</button>
            </div>
        </div>
    </nav>

    <main id="main" class="container" style="padding-top:90px;padding-bottom:60px">
        <!-- Hero -->
        <div class="hero-section">
            <h1>üìã Job Tracking Board</h1>
            <p>Manage your saved and applied jobs in one place. Toggle statuses, add notes, and jump back to the apply link.</p>
        </div>

        <!-- Filters -->
        <div class="filters" id="filterContainer">
            <span class="filter-chip active" data-filter="all">All</span>
            <span class="filter-chip" data-filter="saved">üíæ Saved</span>
            <span class="filter-chip" data-filter="applied">‚úÖ Applied</span>
        </div>

        <!-- Loading Skeleton -->
        <div id="loadingState" style="display:none">
            <div class="skeleton skeleton-tracker"></div>
            <div class="skeleton skeleton-tracker"></div>
            <div class="skeleton skeleton-tracker"></div>
        </div>

        <!-- Error State -->
        <div id="errorState" style="display:none">
            <div class="error-card">
                <div class="error-card-icon">‚ö†Ô∏è</div>
                <div class="error-card-content">
                    <h4>Failed to load board</h4>
                    <p id="errorMessage">Something went wrong. Please try again.</p>
                </div>
            </div>
        </div>

        <!-- Empty State -->
        <div class="empty-state" id="emptyState" style="display:none">
            <div class="empty-state-icon">üìã</div>
            <div class="empty-state-title">No tracked jobs yet</div>
            <p>Save or apply to jobs from search results to see them here.</p>
            <a href="job-search.html" class="btn btn-primary" style="margin-top:12px">Go to Job Search</a>
        </div>

        <!-- Board -->
        <div class="board" id="board"></div>
    </main>

    <script src="js/app.js"></script>
    <script>
        Auth.requireAuth();

        let jobs = [];
        let currentFilter = 'all';

        loadBoard();

        async function loadBoard() {
            document.getElementById('loadingState').style.display = 'block';
            document.getElementById('errorState').style.display = 'none';
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('board').innerHTML = '';

            try {
                const res = await Auth.fetchWithAuth(`${API_BASE}/api/job-matching/tracking-board`);
                if (!res.ok) throw new Error('Failed to load board');
                const data = await res.json();
                jobs = data.jobs || [];
                render();
            } catch (err) {
                document.getElementById('errorState').style.display = 'block';
                document.getElementById('errorMessage').textContent = err.message;
                Toast.show('Failed to load board: ' + err.message, 'error');
            } finally {
                document.getElementById('loadingState').style.display = 'none';
            }
        }

        function render() {
            const board = document.getElementById('board');
            const empty = document.getElementById('emptyState');
            const filtered = jobs.filter(job => {
                if (currentFilter === 'saved') return job.is_saved;
                if (currentFilter === 'applied') return job.is_applied;
                return true;
            });

            if (!filtered.length) {
                board.innerHTML = '';
                empty.style.display = 'block';
                return;
            }
            empty.style.display = 'none';
            board.innerHTML = filtered.map(job => jobCard(job)).join('');
        }

        function jobCard(job) {
            const appliedDate = job.applied_date ? new Date(job.applied_date).toLocaleDateString() : null;
            const esc = s => Toast.escape(s || '');
            return `
                <div class="tracker-card fade-in">
                    <div class="tracker-card-head">
                        <div>
                            <h3 class="tracker-title">${esc(job.title)}</h3>
                            <div class="tracker-meta">${esc(job.company) || 'Unknown'} ¬∑ ${esc(job.location) || 'Remote'} ¬∑ ${esc(job.job_type)}</div>
                        </div>
                        <span class="tracker-chip">${esc(job.source)}</span>
                    </div>
                    <div class="tracker-chips">
                        ${job.match_score ? `<span class="tracker-chip match">Match ${job.match_score}%</span>` : ''}
                        ${job.salary ? `<span class="tracker-chip salary">üí∞ ${esc(job.salary)}</span>` : ''}
                    </div>
                    <div class="status-pills">
                        <span class="pill ${job.is_saved ? 'saved' : 'ghost'}" onclick="toggleSaved(${job.id}, ${!job.is_saved})">${job.is_saved ? 'üíæ Saved' : 'Not saved'}</span>
                        <span class="pill ${job.is_applied ? 'applied' : 'ghost'}" onclick="toggleApplied(${job.id}, ${!job.is_applied})">${job.is_applied ? '‚úÖ Applied' : 'Not applied'}</span>
                        ${appliedDate ? `<span class="tracker-chip">Applied: ${appliedDate}</span>` : ''}
                    </div>
                    <textarea class="tracker-notes" id="note-${job.id}" placeholder="Notes (interviewer, follow-up, reminders‚Ä¶)">${esc(job.notes)}</textarea>
                    <div class="tracker-actions">
                        <button class="btn btn-ghost btn-sm" onclick="openJob('${esc(job.external_url)}')">üîó Open Job</button>
                        <button class="btn btn-primary btn-sm" onclick="saveNotes(${job.id})">üíæ Save Notes</button>
                    </div>
                </div>
            `;
        }

        async function toggleSaved(id, state) { await updateJob(id, { is_saved: state }); }
        async function toggleApplied(id, state) { await updateJob(id, { is_applied: state }); }
        async function saveNotes(id) {
            const notes = document.getElementById(`note-${id}`).value;
            await updateJob(id, { notes });
        }

        async function updateJob(id, payload) {
            try {
                const res = await Auth.fetchWithAuth(`${API_BASE}/api/job-matching/update-job-status`, {
                    method: 'POST',
                    body: JSON.stringify({ job_id: id, ...payload })
                });
                if (!res.ok) throw new Error('Failed to update job');
                // Update local state
                jobs = jobs.map(job => job.id === id ? {
                    ...job,
                    ...payload,
                    is_saved: payload.is_saved ?? job.is_saved,
                    is_applied: payload.is_applied ?? job.is_applied,
                    notes: payload.notes ?? job.notes,
                    applied_date: payload.is_applied ? new Date().toISOString() : job.applied_date
                } : job);
                render();
                Toast.show('Updated successfully', 'success', 2000);
            } catch (err) {
                Toast.show('Update failed: ' + err.message, 'error');
            }
        }

        function openJob(url) {
            if (!url || url === '#' || url === 'undefined') {
                Toast.show('No job link available', 'warning');
                return;
            }
            window.open(url, '_blank');
        }

        // Filter clicks
        document.getElementById('filterContainer').addEventListener('click', (e) => {
            const chip = e.target.closest('.filter-chip');
            if (!chip) return;
            document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
            chip.classList.add('active');
            currentFilter = chip.dataset.filter;
            render();
        });
    </script>
</body>
</html>
